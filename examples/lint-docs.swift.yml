# ============================================================
# Sample CI for Docs Linter (Swift Projects)
# ------------------------------------------------------------
# „Åì„ÅÆ„ÉØ„Éº„ÇØ„Éï„É≠„Éº„ÅØ„ÄÅSwift/Xcode ÈñãÁô∫„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß
# docs-linter „Çí‰ΩøÁî®„Åó„Å¶ Markdown „Éâ„Ç≠„É•„É°„É≥„Éà„ÅÆËá™Âãï lint „ÇíÂÆüË°å„Åô„Çã„Çµ„É≥„Éó„É´„Åß„Åô„ÄÇ
#
# Âà©Áî®ÊñπÊ≥ï:
#  1. „Åì„ÅÆ„Éï„Ç°„Ç§„É´„Çí„Ç≥„Éî„Éº„Åó„Å¶„ÄÅÂà©Áî®ÂÅ¥„É™„Éù„Ç∏„Éà„É™„ÅÆ
#     `.github/workflows/lint-docs.yml` „Å´ÈÖçÁΩÆ„Åó„Åæ„Åô„ÄÇ
#  2. ÂØæË±°„Éë„Çπ„Å™„Å©„ÇíÂêÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥„Åó„Åæ„Åô„ÄÇ
#  3. .textlintrc.swift.jsonc Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÇíÈÖçÁΩÆ„Åó„Åæ„Åô„ÄÇ
#
# ÂøÖÈ†àË¶Å‰ª∂:
#  - Node.js v20+
#  - textlint „Å® docs-linter „Åå package.json „Å´ÁôªÈå≤Ê∏à„Åø„Åß„ÅÇ„Çã„Åì„Å®
#  - .textlintrc.swift.jsonc Ë®≠ÂÆö„Éï„Ç°„Ç§„É´
# ============================================================

name: Lint Docs (Swift)

on:
  push:
    paths:
      - "docs/**/*.md"
      - "**/*.md"
      - ".textlintrc*"
      - "package.json"
      - "*.swift"
      - "*.xcodeproj"
      - "*.xcworkspace"
  pull_request:
    paths:
      - "docs/**/*.md"
      - "**/*.md"
      - ".textlintrc*"
      - "package.json"
      - "*.swift"
      - "*.xcodeproj"
      - "*.xcworkspace"

jobs:
  lint-docs:
    name: Run Docs Linter (Swift)
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # 1. „ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      # submodules: true „Å´„Çà„Çä docs-linter „ÇíÂèñÂæó
      # --------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      # --------------------------------------------------------
      # 2. Node.js „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      # --------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'

      # --------------------------------------------------------
      # 3. ‰æùÂ≠òÈñ¢‰øÇ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
      # docs-linter „Åå submodule „ÅÆÂ†¥Âêà„ÅØÂÄãÂà•„Å´ npm ci „ÇíÂÆüË°å
      # --------------------------------------------------------
      - name: Install dependencies
        run: |
          if [ -d "./docs-linter" ]; then
            echo "Installing docs-linter dependencies..."
            cd docs-linter
            npm ci
            cd ..
            npm install --no-save ./docs-linter
          else
            echo "docs-linter not found as submodule. Installing via npm..."
            npm install --save-dev @stein2nd/docs-linter || true
          fi

      # --------------------------------------------------------
      # 4. Swift Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
      # --------------------------------------------------------
      - name: Check Swift textlint configuration
        run: |
          if [ -f ".textlintrc.swift.jsonc" ]; then
            echo "Using .textlintrc.swift.jsonc (Swift configuration with textlint-rule-preset-swift-docs-ja)"
          elif [ -f ".textlintrc.jsonc" ]; then
            echo "Using .textlintrc.jsonc (fallback to general configuration)"
          elif [ -f ".textlintrc" ]; then
            echo "Using .textlintrc (fallback to general configuration)"
          else
            echo "::warning::No Swift-specific textlint configuration found. Using default settings."
          fi

      # --------------------------------------------------------
      # 5. Swift „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÅÆÁ¢∫Ë™ç
      # --------------------------------------------------------
      - name: Check Swift project structure
        run: |
          if [ -f "Package.swift" ]; then
            echo "Swift Package Manager project detected"
            # „Éë„ÉÉ„Ç±„Éº„Ç∏Âêç„ÇíÊäΩÂá∫
            PACKAGE_NAME=$(grep -E "name:" Package.swift | head -1 | cut -d: -f2 | tr -d '",' | xargs || echo "Unknown")
            echo "Package Name: $PACKAGE_NAME"
          elif [ -f "*.xcodeproj" ] || [ -f "*.xcworkspace" ]; then
            echo "Xcode project detected"
            # Xcode „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂêç„ÇíÊäΩÂá∫
            if [ -f "*.xcodeproj" ]; then
              PROJECT_NAME=$(ls *.xcodeproj | sed 's/\.xcodeproj$//' | head -1)
              echo "Xcode Project: $PROJECT_NAME"
            fi
          else
            echo "::warning::No Swift project structure detected."
          fi

      # --------------------------------------------------------
      # 6. Lint ÂÆüË°åÔºàSwift Ë®≠ÂÆöÔºâ
      # --------------------------------------------------------
      - name: Run textlint (Swift)
        if: "!contains(github.event.head_commit.message, '[skip-lint]')"
        run: |
          # Swift Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®
          if [ -f ".textlintrc.swift.jsonc" ]; then
            CONFIG_FILE=".textlintrc.swift.jsonc"
          elif [ -f ".textlintrc.jsonc" ]; then
            CONFIG_FILE=".textlintrc.jsonc"
          else
            CONFIG_FILE=".textlintrc"
          fi
          
          echo "Using configuration file: $CONFIG_FILE"
          
          # ÂØæË±°„Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
          if [ -d "docs" ]; then
            echo "Linting docs directory with Swift rules..."
            npx textlint --config "$CONFIG_FILE" "docs/**/*.md" || {
              echo "::error::Textlint found issues in docs directory."
              exit 1
            }
          fi
          
          # README „Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™ç
          if [ -f "README.md" ]; then
            echo "Linting README.md with Swift rules..."
            npx textlint --config "$CONFIG_FILE" "README.md" || {
              echo "::error::Textlint found issues in README.md."
              exit 1
            }
          fi
          
          # CHANGELOG „Éï„Ç°„Ç§„É´„ÅÆÁ¢∫Ë™çÔºàSwift „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åß„Çà„Åè‰ΩøÁî®„Åï„Çå„ÇãÔºâ
          if [ -f "CHANGELOG.md" ]; then
            echo "Linting CHANGELOG.md with Swift rules..."
            npx textlint --config "$CONFIG_FILE" "CHANGELOG.md" || {
              echo "::error::Textlint found issues in CHANGELOG.md."
              exit 1
            }
          fi

      # --------------------------------------------------------
      # 7. Swift ÁâπÊúâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
      # --------------------------------------------------------
      - name: Swift-specific checks
        run: |
          echo "Running Swift-specific documentation checks..."
          
          # Package.swift „ÅÆÂøÖÈ†àÈ†ÖÁõÆ„ÉÅ„Çß„ÉÉ„ÇØ
          if [ -f "Package.swift" ]; then
            echo "Checking Package.swift structure..."
            
            # ÂøÖÈ†àÈ†ÖÁõÆ„ÅÆÁ¢∫Ë™ç
            REQUIRED_FIELDS=("name:" "products:" "dependencies:")
            for field in "${REQUIRED_FIELDS[@]}"; do
              if ! grep -q "$field" Package.swift; then
                echo "::warning::Missing required field in Package.swift: $field"
              fi
            done
            
            # „Éê„Éº„Ç∏„Éß„É≥ÂΩ¢Âºè„ÅÆÁ¢∫Ë™ç
            if grep -q "version:" Package.swift; then
              VERSION=$(grep "version:" Package.swift | cut -d: -f2 | tr -d '",' | xargs)
              if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
                echo "::warning::Version format in Package.swift may be incorrect: $VERSION"
              fi
            fi
          fi
          
          # Xcode „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÁ¢∫Ë™ç
          if [ -f "*.xcodeproj" ]; then
            echo "Checking Xcode project structure..."
            # „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
            if [ ! -f "*.xcodeproj/project.pbxproj" ]; then
              echo "::warning::Xcode project file may be corrupted or missing."
            fi
          fi

      # --------------------------------------------------------
      # 8. Swift „Ç≥„Éº„Éâ„Ç≥„É°„É≥„Éà„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
      # --------------------------------------------------------
      - name: Check Swift code comments
        run: |
          echo "Checking Swift code comments for documentation..."
          
          # Swift „Éï„Ç°„Ç§„É´ÂÜÖ„ÅÆ„Ç≥„É°„É≥„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
          if find . -name "*.swift" -type f | head -1 | grep -q .; then
            echo "Found Swift files, checking comments..."
            
            # „Éâ„Ç≠„É•„É°„É≥„Éà„Ç≥„É°„É≥„Éà„ÅÆÁ¢∫Ë™ç
            DOC_COMMENTS=$(find . -name "*.swift" -type f -exec grep -l "///" {} \; | wc -l)
            if [ "$DOC_COMMENTS" -gt 0 ]; then
              echo "Found $DOC_COMMENTS Swift files with documentation comments"
            else
              echo "::info::No documentation comments found in Swift files"
            fi
            
            # TODO „Ç≥„É°„É≥„Éà„ÅÆÁ¢∫Ë™ç
            TODO_COUNT=$(find . -name "*.swift" -type f -exec grep -c "TODO" {} \; | awk '{sum += $1} END {print sum}')
            if [ "$TODO_COUNT" -gt 0 ]; then
              echo "::warning::Found $TODO_COUNT TODO comments in Swift files"
            fi
          fi

      # --------------------------------------------------------
      # 9. „É¨„Éù„Éº„ÉàÂá∫ÂäõÔºàÂ§±ÊïóÊôÇÔºâ
      # --------------------------------------------------------
      - name: Save lint report
        if: failure()
        run: |
          mkdir -p reports
          npx textlint "docs/**/*.md" "README.md" "CHANGELOG.md" -f json > reports/textlint-report.json 2>/dev/null || true
        continue-on-error: true

      # --------------------------------------------------------
      # 10. „Ç¢„Éº„ÉÜ„Ç£„Éï„Ç°„ÇØ„Éà„Å®„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
      # --------------------------------------------------------
      - name: Upload lint report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: textlint-report-swift-${{ github.run_number }}
          path: reports/textlint-report.json
          if-no-files-found: ignore

      # --------------------------------------------------------
      # 11. „Ç≥„É°„É≥„ÉàÊäïÁ®øÔºàPR „ÅÆÂ†¥ÂêàÔºâ
      # --------------------------------------------------------
      - name: Comment PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('reports/textlint-report.json', 'utf8');
            } catch (e) {
              report = 'Lint report not available.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üìù Swift Documentation Lint Results
              
              Textlint found issues in the Swift documentation. Please review and fix the following:
              
              \`\`\`json
              ${report}
              \`\`\`
              
              **Swift-specific notes:**
              - Make sure technical terms follow Apple's Japanese translation guidelines
              - Check that code examples are properly formatted
              - Verify that the documentation follows Swift API Design Guidelines
              - Ensure proper spacing around English terms and code blocks
              - Using textlint-rule-preset-swift-docs-ja for Swift-specific linting rules
              
              For more information, see the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).
              `
            });
