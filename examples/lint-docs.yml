# ============================================================
# Sample CI for Docs Linter
# ------------------------------------------------------------
# ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã€docs-linter ã‚’ submodule ã¾ãŸã¯ npm ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦
# åˆ©ç”¨ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ã€Markdown ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è‡ªå‹• lint ã‚’å®Ÿè¡Œã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚
#
# åˆ©ç”¨æ–¹æ³•:
#  1. ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€åˆ©ç”¨å´ãƒªãƒã‚¸ãƒˆãƒªã®
#     `.github/workflows/lint-docs.yml` ã«é…ç½®ã—ã¾ã™ã€‚
#  2. å¯¾è±¡ãƒ‘ã‚¹ãªã©ã‚’å„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦èª¿æ•´ã—ã¾ã™ã€‚
#  3. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ãŸ .textlintrc è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¾ã™ã€‚
#
# å¿…é ˆè¦ä»¶:
#  - Node.js v20+
#  - textlint ã¨ docs-linter ãŒ package.json ã«ç™»éŒ²æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
#  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¿œã˜ãŸ .textlintrc è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
# ============================================================

name: Lint Docs

on:
  push:
    paths:
      - "docs/**/*.md"
      - "**/*.md"
      - ".textlintrc*"
      - "package.json"
  pull_request:
    paths:
      - "docs/**/*.md"
      - "**/*.md"
      - ".textlintrc*"
      - "package.json"

jobs:
  lint-docs:
    name: Run Docs Linter
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # 1. ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # submodules: true ã«ã‚ˆã‚Š docs-linter ã‚’å–å¾—
      # --------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true

      # --------------------------------------------------------
      # 2. Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # --------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # --------------------------------------------------------
      # 2.5. npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€é©åŒ–
      # å®Ÿè¡Œé€Ÿåº¦ãŒç´„3å€ã«ãªã‚‹ã€CIå¤±æ•—æ™‚ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç ´æé˜²æ­¢ã«ã‚‚åŠ¹æœçš„
      # --------------------------------------------------------
      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # --------------------------------------------------------
      # 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # docs-linter ãŒ submodule ã®å ´åˆã¯å€‹åˆ¥ã« npm ci ã‚’å®Ÿè¡Œ
      # --------------------------------------------------------
      - name: Install dependencies
        run: |
          if [ -d "./docs-linter" ]; then
            echo "Installing docs-linter dependencies..."
            cd docs-linter
            npm ci
            cd ..
            npm install --no-save ./docs-linter
          else
            echo "docs-linter not found as submodule. Installing via npm..."
            npm install --save-dev @stein2nd/docs-linter || true
          fi

      # --------------------------------------------------------
      # 3.5. textlint ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šï¼ˆç ´å£Šçš„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®äºˆé˜²ï¼‰
      # --------------------------------------------------------
      - name: Install textlint (version pinned)
        run: npm install textlint@15.4.0

      # --------------------------------------------------------
      # 4. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
      # --------------------------------------------------------
      - name: Check textlint configuration
        run: |
          if [ -f ".textlintrc.jsonc" ]; then
            echo "Using .textlintrc.jsonc"
          elif [ -f ".textlintrc" ]; then
            echo "Using .textlintrc"
          else
            echo "::warning::No textlint configuration found. Using default settings."
          fi

      # --------------------------------------------------------
      # 5. Lint å®Ÿè¡Œ
      # CI ã§ã¯ docs ã®ã¿ã‚’å¯¾è±¡ï¼ˆREADME.md ã¨ docs/**/*.mdã€è‡ªå‹• fix ã¯ offï¼‰
      # ä»–ãƒ•ã‚©ãƒ«ãƒ€ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ lint ã¨ã„ã†æ–¹é‡
      # --------------------------------------------------------
      - name: Run textlint
        if: "!contains(github.event.head_commit.message, '[skip-lint]')"
        run: |
          # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f ".textlintrc.jsonc" ]; then
            CONFIG_FILE=".textlintrc.jsonc"
          elif [ -f ".textlintrc.json" ]; then
            CONFIG_FILE=".textlintrc.json"
          elif [ -f ".textlintrc" ]; then
            CONFIG_FILE=".textlintrc"
          else
            echo "::warning::No textlint configuration found. Using default settings."
            CONFIG_FILE=""
          fi

          # README ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
          if [ -f "README.md" ]; then
            echo "Linting README.md..."
            if [ -n "$CONFIG_FILE" ]; then
              npx textlint --config "$CONFIG_FILE" "README.md" || {
                echo "::error::Textlint found issues in README.md."
                exit 1
              }
            else
              npx textlint "README.md" || {
                echo "::error::Textlint found issues in README.md."
                exit 1
              }
            fi
          fi

          # docs ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºèª
          if [ -d "docs" ]; then
            echo "Linting docs directory..."
            if [ -n "$CONFIG_FILE" ]; then
              npx textlint --config "$CONFIG_FILE" "docs/**/*.md" || {
                echo "::error::Textlint found issues in docs directory."
                exit 1
              }
            else
              npx textlint "docs/**/*.md" || {
                echo "::error::Textlint found issues in docs directory."
                exit 1
              }
            fi
          fi

      # --------------------------------------------------------
      # 6. ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ï¼ˆå¤±æ•—æ™‚ï¼‰
      # --------------------------------------------------------
      - name: Save lint report
        if: failure()
        run: |
          mkdir -p reports
          npx textlint "docs/**/*.md" "README.md" -f json > reports/textlint-report.json 2>/dev/null || true
        continue-on-error: true

      # --------------------------------------------------------
      # 7. ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # --------------------------------------------------------
      - name: Upload lint report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: textlint-report-${{ github.run_number }}
          path: reports/textlint-report.json
          if-no-files-found: ignore

      # --------------------------------------------------------
      # 8. ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆPR ã®å ´åˆï¼‰
      # --------------------------------------------------------
      - name: Comment PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('reports/textlint-report.json', 'utf8');
            } catch (e) {
              report = 'Lint report not available.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ“ Documentation Lint Results

              Textlint found issues in the documentation. Please review and fix the following:

              \`\`\`json
              ${report}
              \`\`\`

              For more information, see the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).
              `
            });
